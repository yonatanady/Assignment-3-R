---
title: "Assignment 3 (R)"
author: "Yonatan Ady, Nicole Keefner, Swan Tan"
date: "April 1, 2018"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 12, fig.height = 8, fig.path = 'Figures/')
```

```{r library}
library(tidyverse)
library(gridExtra)
library(knitr)
library(plotly)
```

```{r data}
download.file("https://ndownloader.figshare.com/files/2292169", "data/portal_data_joined.csv")

surveys <- read_csv("data/portal_data_joined.csv")
```


## Working with data and writing a report using R

This report will summarize what we have done for this group assignment.
There are 3 separate chapters that we use to group our work :

1. Exploratory Analysis.

2. Analysis based on Rodent.

3. Statistical Analysis.


## Chapter 1. Exploratory Analysis

```{r Overall distribution of the species by taxa}
surveys_taxa <- surveys %>%
    filter(!is.na(taxa)) %>% group_by(taxa) %>% 
    tally()

```

```{r species pie chart}
plot_ly(surveys_taxa, labels = ~taxa, values = ~n, type = 'pie',textposition = 'outside',
        domain = list(x = c(0, 0), y = c(0, 0)), textinfo = 'label+percent',
        rotation = -108, direction = "clockwise", 
        textfont = list(color = '#000000', size = 16)) %>%
    layout(title = 'Taxa Distribution', xaxis = list(showgrid = FALSE, zeroline = FALSE, 
                                                     showticklabels = FALSE), 
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

```{r To find out what are the species and how many of them for each taxa}
surveys_species <- surveys %>%
    filter(!is.na(taxa), !is.na(genus), !is.na(species), !species_id == "") %>%
    mutate(species_name = paste(genus, species)) %>% group_by(taxa, species_name, species_id) %>% 
    tally()
```

```{r Bird distribution}
bird_species <- surveys_species %>% filter(taxa == "Bird") %>% 
    group_by(taxa, species_id)
```

```{r Rabbit distribution}
rabbit_species <- surveys_species %>% filter(taxa == "Rabbit") %>% 
    group_by(taxa, species_id) 
```

```{r Reptile distribution}
reptile_species <- surveys_species %>% filter(taxa == "Reptile") %>% 
    group_by(taxa, species_id) 
```

```{r Rodent distribution}
rodent_species <- surveys_species %>% filter(taxa == "Rodent") %>% 
    group_by(taxa, species_id) 
```

```{r Pie chart for each taxa except rodent}
b <- plot_ly(bird_species, labels = ~species_name, values = ~n, type = 'pie',
             domain = list(x = c(0, 0.5), y = c(0.55, 1)), textposition = 'inside',
             textinfo = 'label+percent', textfont = list(color = '#000000', size = 12)) %>%
    layout(xaxis = list(title = "Bird", showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

ra <- plot_ly(rabbit_species, labels = ~species_name, values = ~n, type = 'pie',
              domain = list(x = c(0.5, 1), y = c(0.55, 1)), textposition = 'inside',
              textinfo = 'label+percent', textfont = list(color = '#000000', size = 12)) %>%
    layout(xaxis = list(title = "Rabbit", showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

re <- plot_ly(reptile_species, labels = ~species_name, values = ~n, type = 'pie',
              domain = list(x = c(0, 0.5), y = c(0, 0.45)), textposition = 'inside',
              textinfo = 'label+percent', textfont = list(color = '#000000', size = 12)) %>%
    layout(xaxis = list(title = "Reptile", showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

ro <- plot_ly(rodent_species, labels = ~species_name, values = ~n, type = 'pie',
              domain = list(x = c(0.5, 1), y = c(0, 0.45)), textposition = 'inside',
              textinfo = 'label+percent') %>%
    layout(xaxis = list(title = "Rodent", showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

```

```{r Combined multiple pie charts}
subplot(b, ra, re, ro, nrows = 2, titleX = TRUE) %>% 
    layout(title = "Distribution of Species According to Taxa", 
           showlegend = FALSE,
           xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

```{r Taxa information according to years}
surveys_taxa_years <- surveys %>%
    select(taxa,year) %>%
    group_by(taxa, year) %>% tally()

surveys_taxa_years$year <- as.factor(surveys_taxa_years$year)
```

```{r taxa by years chart}
ggplot(surveys_taxa_years, aes(x = year, y = n)) + 
    geom_bar(stat = "identity") + facet_wrap(~taxa, scales = "free_y") +
    theme_linedraw() + theme(legend.position = "right") +
    labs(title = "Taxa Information According to Year", 
         x = "Year", y = "Count (n)") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(angle = 68, hjust = 1, size = 9)) +
    theme(axis.text.y = element_text(size = 9))
```

```{r Weight according to species}
surveys_weight <- surveys %>%
    filter(!is.na(year), !is.na(weight), !species_id == "") %>%
    group_by(year, species_id) %>% 
    mutate(average_weight = mean(weight)) 
```

```{r Time series chart}
ggplot(surveys_weight, aes(x = year, y = average_weight)) + 
    geom_line(aes(color = species_id)) + theme_classic() + 
    theme(legend.position = "right") +
    labs(title = "Distribution of Species Average Weight According to Year", x = "Year", 
         y = "Average Weight (g)", color = "Species ID") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(size = 9)) +
    theme(axis.text.y = element_text(size = 9)) 
```

## Chapter 2. Analysis based on Rodent Data

Based on preliminary investigations, we determined that Rodent was the only taxon for which hindfoot length or sex were recorded. Because of this, any graphs including information about hindfoot length or sex will be strictly for rodent species in the study. The number of rodents in the study is below.

```{r Average rodent hindfoot length according to species_id for each taxa}
surveys_hfoot_id <- surveys %>%
    filter(!is.na(hindfoot_length), !taxa == "", !species_id == "") %>% 
    group_by(species_id) %>%
    mutate(average_hfoot = mean(hindfoot_length))

summary(as.factor(surveys_hfoot_id$taxa))
```

```{r Average rodent hindfoot length graph}
ggplot(surveys_hfoot_id, aes(x = species_id, y = average_hfoot)) +
    theme_classic() + theme(legend.position = "right") +
    labs(title = "Average Rodent Hindfoot Length by Species ID", x = "Species ID", 
         y = "Hindfoot Length (cm)") + 
    stat_summary(fun.y = "mean", geom = "bar") +
    geom_text(aes(label=round(average_hfoot)), vjust=-0.3, size=3.5) +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(angle = 68, hjust = 1, size = 9)) +
    theme(axis.text.y = element_text(size = 9))
```

```{r Average rodent hindfoot length according to plot type}
surveys_hfoot_plottype <- surveys %>%
    filter(!is.na(hindfoot_length), !plot_type == "") 
```

```{r Average rodent hindfoot length according to plot type graph}
ggplot(aes(x = plot_type, y = hindfoot_length), data = surveys_hfoot_plottype) + 
    stat_summary(fun.y = "mean", geom = "bar") + theme_classic() + 
    theme(legend.position = "right") +
    labs(title = "Average Rodent Hindfoot Length by Plot Type", x = "Plot Type", 
         y = "Hindfoot Length (cm)") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(angle = 68, hjust = 1, size = 9)) +
    theme(axis.text.y = element_text(size = 9))
```

```{r Distribution of rodent}
plot_ly(rodent_species, labels = ~species_name, values = ~n, type = 'pie',
              domain = list(x = c(0, 0), y = c(0, 0)), textposition = 'inside',
              textinfo = 'label+percent') %>%
    layout(title = "Distribution of Rodents", 
           xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
           yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

```{r To correlate hindfoot_length and weight of rodent}
rodent_complete <- surveys %>% 
    filter(!is.na(sex), !is.na(hindfoot_length), !is.na(weight), !is.na(plot_type))
rodent_complete$year <- as.factor(rodent_complete$year)
```

```{r Year capture according to rodent species_id}
rodent_genus_year <- rodent_complete %>% select(genus, species_id, year) %>% 
    group_by(genus, species_id, year) %>% tally()
```

```{r Year capture according to rodent species_id graph}
spp_year_count <- ggplot(rodent_genus_year, aes(x = year, y = n, fill = species_id)) + 
    geom_bar(stat = "identity") + theme_classic() + theme(legend.position = "right") +
    labs(title = "Species Captured According to Year", x = "Year", 
         y = "Count (n)", fill = "Species ID") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(angle = 68, hjust = 1, size = 9)) +
    theme(axis.text.y = element_text(size = 9))
```

```{r Sex information according to taxa}
surveys_taxa_sex <- surveys %>%
    filter(!is.na(sex)) %>% select(taxa,sex) %>%
    group_by(taxa, sex) %>% tally()
```

```{r Sex information according to taxa graph}
ggplot(surveys_taxa_sex, aes(x = sex, y = n)) + 
    geom_bar(stat = "identity") +
    theme_classic() + theme(legend.position = "right") +
    labs(title = "Sex Distribution of Rodents", x = "Sex", y = "Count (n)") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(size = 9)) +
    scale_x_discrete(labels = c("Female", "Male")) +
    theme(axis.text.y = element_text(size = 9))
```

```{r Female and male distribution according to species_id}
rodent_species_sex <- rodent_complete %>% select(species_id, sex) %>%
    group_by(species_id, sex) %>% tally()
```

```{r Female and male distribution according to species_id graph}
spp_sex_count <- ggplot(rodent_species_sex, aes(x = species_id, y = log(n), fill = sex)) + 
    geom_bar(stat = "identity") + theme_classic() + theme(legend.position = "right") +
    labs(title = "Sex Distribution of Species", x = "Species ID", 
         y = "Count \n log(n)", fill = "Sex") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(angle = 68, hjust = 1, size = 9)) +
    theme(axis.text.y = element_text(size = 9))

```

```{r Combine both plot}
grid.arrange(spp_year_count, spp_sex_count, ncol = 2, widths = c(5,5))
```

```{r Density of weight according to sex for each plot type}
ggplot(rodent_complete, aes(x = weight, fill = sex)) +
    geom_density(alpha = 0.6) + facet_wrap(~ plot_type) + theme_linedraw() + 
    theme(legend.position = "right") +
    labs(title = "Weight Density According to Sex for Each Plot Type", x = "Weight (g)", 
         y = "Density", fill = "Sex") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(size = 9)) +
    theme(axis.text.y = element_text(size = 9))
```

```{r Density of hindfoot_length according to sex for each plot type}
ggplot(rodent_complete, aes(x = hindfoot_length, fill = sex)) +
    geom_density(alpha = 0.6) + facet_wrap(~ plot_type) +
    theme_linedraw() + theme(legend.position = "right") +
    labs(title = "Hindfoot Length Density According to Sex for Each Plot Type", 
         x = "Hindfoot Length (cm)", y = "Density", fill = "Sex") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(size = 9)) +
    theme(axis.text.y = element_text(size = 9))

```

```{r Density of species per year for each plot type}
rodent_complete <- surveys %>% 
    filter(!is.na(sex), !is.na(hindfoot_length), !is.na(weight), !is.na(plot_type))
```

```{r Density of species per year for each plot type graph}
ggplot(rodent_complete, aes(x = year, fill = species_id)) +
    geom_density(alpha = 0.6) + facet_wrap(~ plot_type) +
    theme_linedraw() + theme(legend.position = "right") +
    labs(title = "Species Density per Year for Each Plot Type", 
         x = "Year", y = "Density", fill = "Species ID") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(size = 9)) + 
    theme(axis.text.y = element_text(size = 9))
```

```{r To correlate hind_foot length and weight according to species_id}
ggplot(rodent_complete, aes(x = weight, y = hindfoot_length)) + 
    geom_point(aes(color = species_id)) +
    geom_smooth(method = "lm", se = FALSE, color = 'maroon') +
    theme_classic() + theme(legend.position = "right") +
    labs(title = "Relationship between Hindfoot Length and Weight of Species", 
         x = "Weight (g)", y = "Hindfoot Length (cm)", color = "Species ID") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(size = 9)) +
    theme(axis.text.y = element_text(size = 9))
```

```{r Difference between female and male weight}
surveys_weight_sex <- surveys %>%
  filter(!is.na(year), !is.na(weight), !is.na(sex), !species_id == "") %>%
  group_by(species_id, sex) %>% 
  mutate(average_weight = mean(weight))
```

```{r Difference between female and male weight graph}
ggplot(surveys_weight_sex, aes(x = species_id, y = weight)) + 
  geom_boxplot(aes(color = sex)) + theme_classic() + theme(legend.position = "right") +
    labs(title = "Weight for Male and Female Rodents by Species ID", x = "Species ID", 
         y = "Average Weight (g)", color = "Sex") +
    theme(plot.title = element_text(hjust = 0.5, size = 14)) + 
    theme(axis.text.x = element_text(angle = 68, hjust = 1, size = 9)) +
    theme(axis.text.y = element_text(size = 9))
```

## Chapter 3. Statistical Analysis

The above figure of "Weight for Male and Female Rodents by Species ID" suggests there is a relationship between sex and weight (g) in rodents. We conducted a Student's t-test to compare the weights of males to that of females.
```{r Students t-test}
Rodent_Female <- filter(surveys_weight_sex, sex=='F')
Rodent_Male <- filter(surveys_weight_sex, sex=='M')
t.test(Rodent_Female$weight, Rodent_Male$weight)
```
Because the p-value is less than the alpha of 0.05, we reject the null hypothesis that the mean weights of the two sexes are the same. In the output above, "mean of x" is the mean of females and "mean of y" is the mean of males.

The above figure of "Relationship between Hindfoot Length and Weight of Species" suggests there is a relationship between hindfoot length (cm) and weight (g) in rodents. We created a linear model to determine if there is indeed a relationship between these variables.
```{r Linear regression}
fit1 <- lm(hindfoot_length ~ weight, data = rodent_complete)
summary(fit1)
```
Because the p-value is less than the alpha of 0.05, we reject the null hypothesis that the slope of the linear regression model does not differ significantly from zero. In addition, the multiple R-squared value is used to describe how well a given model explains variation in the data. In this case, this model explains 46.73% of the variation in the data.

The above figure of "Average Rodent Hindfoot Length by Species ID" suggests hindfoot length (cm) is different according to species ID. We conducted several tests to determine if this was the case. We began by conducting a Bartlett Test of Homogeneity of Variances to evaluate the homogeneity of variance assumption of ANOVA.
```{r Bartlett Test}
bartlett.test(hindfoot_length~species_id, data=surveys_hfoot_id)
```
Because the p-value is less than the alpha of 0.05, we reject the null hypothesis that variances of the levels of species ID are equal. Because of this, we know our data does not meet the assumptions of the ANOVA and a non-parametric alternative must be used. In this case, we used a Kruskal-Wallis rank sum test.

```{r Kruskal-Wallis rank sum test}
kruskal.test(hindfoot_length~as.factor(species_id), data=surveys_hfoot_id)
```
Because the p-value is less than the alpha of 0.05, we reject the null hypothesis that all species have the same average hindfoot lengths. However, this test did not inform us as to which species are different from which others. In order to determine this, we conducted a non-parametric Pairwise Wilcoxon rank sum test. In the output below, pairs with values <0.05 are significantly different from each other and we reject the null that the group means are the same.
```{r Pairwise Wilcoxon Rank Sum Tests}
pairwise.wilcox.test(surveys_hfoot_id$hindfoot_length, as.factor(surveys_hfoot_id$species_id))
```



